#!/usr/bin/env python3
"""BlockRun CLI - balance, generate, check commands."""

import sys

def main():
    if len(sys.argv) < 2:
        print("Usage: blockrun <command>")
        print("  balance          Show wallet address and USDC balance")
        print("  generate <prompt> Generate image with DALL-E")
        print("  check @user      Check X/Twitter account with Grok")
        sys.exit(1)

    cmd = sys.argv[1].lower()

    if cmd == "balance":
        cmd_balance()
    elif cmd == "generate":
        if len(sys.argv) < 3:
            print("Usage: blockrun generate <prompt>")
            sys.exit(1)
        prompt = " ".join(sys.argv[2:])
        cmd_generate(prompt)
    elif cmd == "check":
        if len(sys.argv) < 3:
            print("Usage: blockrun check @username")
            sys.exit(1)
        user = sys.argv[2]
        cmd_check(user)
    else:
        print(f"Unknown command: {cmd}")
        print("Commands: balance, generate, check")
        sys.exit(1)


def cmd_balance():
    """Show wallet address and balance."""
    try:
        from blockrun_llm import setup_agent_wallet
    except ImportError:
        print("Error: blockrun-llm not installed. Run: pip install blockrun-llm")
        sys.exit(1)

    client = setup_agent_wallet(silent=True)
    addr = client.get_wallet_address()
    balance = client.get_balance()  # SDK has built-in RPC fallback

    print(f"Wallet:  {addr}")
    print(f"Balance: ${balance:.2f} USDC (Base)")
    print(f"View:    https://basescan.org/address/{addr}")


def cmd_generate(prompt: str):
    """Generate image with DALL-E."""
    try:
        from blockrun_llm import ImageClient
    except ImportError:
        print("Error: blockrun-llm not installed. Run: pip install blockrun-llm")
        sys.exit(1)

    print(f"Generating: {prompt}")
    client = ImageClient()

    try:
        result = client.generate(prompt)
        url = result.data[0].url
        print(f"Image: {url}")

        # Try to open in browser
        try:
            import webbrowser
            webbrowser.open(url)
        except:
            pass
    except Exception as e:
        print(f"Error: {e}")
        sys.exit(1)


def cmd_check(user: str):
    """Check X/Twitter account with Grok."""
    try:
        from blockrun_llm import setup_agent_wallet
    except ImportError:
        print("Error: blockrun-llm not installed. Run: pip install blockrun-llm")
        sys.exit(1)

    # Clean up username
    user = user.lstrip("@")

    print(f"Checking @{user} on X...")
    client = setup_agent_wallet(silent=True)

    try:
        response = client.chat(
            "xai/grok-3",
            f"Give a brief summary of @{user}'s recent X/Twitter activity, engagement, and what they're focused on.",
            search_parameters={
                "mode": "on",
                "sources": [{"type": "x", "included_x_handles": [user]}],
                "max_search_results": 10,
                "return_citations": True
            }
        )
        print()
        print(response)

        # Show cost
        spending = client.get_spending()
        print()
        print(f"Cost: ${spending['total_usd']:.2f}")
    except Exception as e:
        print(f"Error: {e}")
        sys.exit(1)


if __name__ == "__main__":
    main()
